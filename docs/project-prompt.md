# Prompt: Build "CAAB API Certificacao" from scratch

Build a complete REST API (CRUD) called **caab-api-certificacao** that uses a Google Spreadsheet as its database for a "Primeira Certificacao" (first certification) workflow. The spreadsheet has two sheets: **tickets** and **pedidos**. The API must support dual deployment to Docker (VPS) and Vercel (serverless).

Use **pnpm** as the package manager (not npm). Use `.env.local` as the environment file (not `.env`).

---

## 1. Spreadsheet Details

- **Spreadsheet ID:** `1_EsiaEyJZKKmfpyWU2cwC7D6YkkP1v4OH_127n5Zpj8`
- **Sheet "tickets":** single column A with header "Ticket". Each row is a ticket string (e.g. CPF number).
- **Sheet "pedidos":** columns A through I with headers: `UUID | Ticket | Numero da OAB | Nome completo | Subsecao | Data Solicitacao | Data Liberacao | Status | Anotacoes`. UUID is auto-generated by the API using `crypto.randomUUID()`.

---

## 2. Tech Stack (exact versions in package.json)

| Category | Package | Version constraint |
|---|---|---|
| Runtime | Node.js | `>=18.0.0` (engines field) |
| Framework | express | `^4.18.2` |
| Google API | googleapis | `^129.0.0` |
| Validation | zod | `^3.22.0` |
| CORS | cors | `^2.8.5` |
| Env | dotenv | `^16.3.1` |
| API Docs | swagger-jsdoc | `^6.2.8` |
| API Docs UI | swagger-ui-express | `^5.0.1` |
| **devDependencies** | | |
| TypeScript | typescript | `^5.3.0` |
| TS runner | tsx | `^4.7.0` |
| Linter | eslint | `^9.39.2` |
| Linter TS plugin | typescript-eslint | `^8.55.0` |
| ESLint base | @eslint/js | `^9.39.2` |
| Types | @types/node `^20.11.0`, @types/express `^4.17.21`, @types/cors `^2.8.17`, @types/swagger-jsdoc `^6.0.4`, @types/swagger-ui-express `^4.1.8` | |

**package.json metadata:**
- name: `caab-api-certificacao`, version: `1.0.0`
- main: `dist/index.js`
- keywords: `["api", "google-sheets", "certificacao"]`
- license: ISC
- Add a `pnpm` field: `{ "onlyBuiltDependencies": ["esbuild"], "ignoredBuiltDependencies": ["@scarf/scarf"] }`

**Scripts:**
```json
{
  "build": "tsc",
  "start": "node dist/index.js",
  "dev": "tsx watch src/index.ts",
  "lint": "eslint src/",
  "lint:fix": "eslint src/ --fix"
}
```

---

## 3. TypeScript Config (`tsconfig.json`)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "outDir": "dist",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

---

## 4. ESLint 9 Flat Config (`eslint.config.mjs`)

Use ESM syntax. Import `@eslint/js` and `typescript-eslint`. Apply recommended configs for both. Ignore `dist/` and `node_modules/`. Custom rules:
- `@typescript-eslint/no-explicit-any`: `"warn"`
- `@typescript-eslint/no-unused-vars`: `["error", { argsIgnorePattern: "^_", varsIgnorePattern: "^_" }]`

---

## 5. File Structure

Create exactly this structure:

```
caab-api-certificacao/
├── api/
│   └── index.ts
├── postman/
│   └── caab-api-certificacao.postman_collection.json
├── src/
│   ├── index.ts
│   ├── app.ts
│   ├── config/
│   │   ├── sheets.ts
│   │   └── swagger.ts
│   ├── middleware/
│   │   ├── basicAuth.ts
│   │   └── rateLimiter.ts
│   ├── routes/
│   │   ├── tickets.ts
│   │   └── pedidos.ts
│   ├── schemas/
│   │   ├── ticket.ts
│   │   └── pedido.ts
│   ├── services/
│   │   ├── ticketsService.ts
│   │   └── pedidosService.ts
│   └── utils/
│       ├── response.ts
│       └── writeLock.ts
├── .env.example
├── .gitignore
├── .dockerignore
├── CLAUDE.md
├── Dockerfile
├── docker-compose.yml
├── eslint.config.mjs
├── package.json
├── README.md
├── tsconfig.json
└── vercel.json
```

---

## 6. Environment Variables

**`.env.example`** (committed):
```
GOOGLE_APPLICATION_CREDENTIALS=./credentials.json
SPREADSHEET_ID=1_EsiaEyJZKKmfpyWU2cwC7D6YkkP1v4OH_127n5Zpj8
PORT=3000
API_USERS=admin:changeme
```

The actual file used at runtime is `.env.local` (git-ignored). Load it with `dotenv.config({ path: ".env.local" })`.

Variables:
| Variable | Purpose | Where used |
|---|---|---|
| `GOOGLE_APPLICATION_CREDENTIALS` | Path to `credentials.json` file | Docker/VPS |
| `GOOGLE_CREDENTIALS_JSON` | Stringified JSON of the service account credentials | Vercel |
| `SPREADSHEET_ID` | The Google Spreadsheet ID | Both |
| `PORT` | Server port (default 3000) | VPS/Docker |
| `API_USERS` | Basic Auth users, format `user1:pass1,user2:pass2` | Both |

---

## 7. Source Code — Exact Implementation

### 7.1 `src/utils/response.ts` — Standardized response helpers

Three functions:
- `success(data)` → `{ success: true, data }`
- `successList(data[])` → `{ success: true, count: data.length, data }`
- `error(message)` → `{ success: false, error: message }`

### 7.2 `src/utils/writeLock.ts` — Promise-chain mutex

A module-level `let chain = Promise.resolve()`. The `withWriteLock<T>(fn)` function appends `fn` to the chain so that writes are serialized. It creates a new `Promise<T>`, stores its `resolve`/`reject`, then chains the execution of `fn` onto `chain`. Returns the promise.

### 7.3 `src/config/sheets.ts` — Google Auth + Sheets client

- Scope: `https://www.googleapis.com/auth/spreadsheets`
- Caches the Sheets client in a module-level variable
- Two auth modes:
  1. If `GOOGLE_CREDENTIALS_JSON` env var exists → parse it as JSON and pass as `credentials` to `GoogleAuth`
  2. Else use `GOOGLE_APPLICATION_CREDENTIALS` env var as `keyFile` path (resolved with `path.resolve`)
  3. Throw if neither is set
- Add an `eslint-disable` comment for the `any` cast on the auth parameter when calling `google.sheets()`
- Export `getSheetsClient()` and `getSpreadsheetId()`

### 7.4 `src/config/swagger.ts` — OpenAPI 3.0 spec via swagger-jsdoc

- OpenAPI version: `3.0.0`
- Title: `CAAB API Certificacao`, version `1.0.0`
- Description: `REST API (CRUD) for "Primeira Certificacao" Google Spreadsheet`
- Security scheme: HTTP Basic (`basicAuth`)
- Global security: `[{ basicAuth: [] }]`
- `apis` glob: `["./src/routes/*.ts"]`
- Define these component schemas:
  - **Ticket**: `{ ticket: string }` (example: `"12345678900"`)
  - **Pedido**: all 9 fields (uuid, ticket, numero_oab, nome_completo, subsecao, data_solicitacao, data_liberacao, status, anotacoes) with examples
  - **CreatePedido**: required `[ticket, nome_completo]`, optional fields with examples; date fields have pattern `^\d{4}-\d{2}-\d{2}$`
  - **SuccessResponse**: `{ success: boolean, data: object }`
  - **ListResponse**: `{ success: boolean, count: integer, data: array }`
  - **ErrorResponse**: `{ success: boolean, error: string }`

### 7.5 `src/schemas/ticket.ts` — Zod schemas

- `createTicketSchema`: `z.object({ ticket: z.string().min(1) })`
- `updateTicketSchema`: same shape

### 7.6 `src/schemas/pedido.ts` — Zod schemas

- `createPedidoSchema`:
  - `ticket`: `z.string().min(1)` (required)
  - `nome_completo`: `z.string().min(1)` (required)
  - `numero_oab`: `z.string().optional().default("")`
  - `subsecao`: `z.string().optional().default("")`
  - `data_solicitacao`: `z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional().default("")`
  - `data_liberacao`: same regex pattern, optional, default `""`
  - `status`: `z.string().optional().default("")`
  - `anotacoes`: `z.string().optional().default("")`
- `updatePedidoSchema`: `createPedidoSchema.partial()`

### 7.7 `src/middleware/rateLimiter.ts`

Uses an in-memory `Map<string, RateLimitData>` keyed by client IP (`req.ip || req.socket.remoteAddress || "unknown"`).

**RateLimitData interface:** `{ count, windowStart, authFailures, authFailStart }` (all numbers).

**Constants:**
- `WINDOW_MS = 60_000` (1 min)
- `MAX_REQUESTS = 100`
- `AUTH_FAIL_WINDOW_MS = 15 * 60 * 1000` (15 min)
- `MAX_AUTH_FAILURES = 5`

**Cleanup:** `setInterval` every 60s deletes entries older than `Math.max(WINDOW_MS, AUTH_FAIL_WINDOW_MS)`.

**Exports:**
- `rateLimiter` middleware: counts requests per window, returns 429 with `Retry-After` header if over limit
- `trackAuthFailure(req)`: increments auth failure count for the client
- `isAuthBlocked(req)`: returns true if failures >= 5 in window
- `authRateLimiter` middleware: checks `isAuthBlocked`, returns 429 if blocked

### 7.8 `src/middleware/basicAuth.ts`

- Parses `API_USERS` env var into a `Record<string, string>` (cached after first parse)
- Uses `crypto.timingSafeEqual` for password comparison (with equal-length buffer trick: if lengths differ, compare `bufA` with itself to maintain constant time, then return false)
- On failure: calls `trackAuthFailure(req)`, sets `WWW-Authenticate: Basic realm="API"` header, returns 401
- On success: sets `req.user` to the username and calls `next()`

### 7.9 `src/services/ticketsService.ts`

- Sheet name: `"tickets"`, range: `tickets!A:A`
- **Cache:** module-level `cache: string[] | null`, `cacheTime: number`, TTL = 5 min. `invalidateCache()` resets both.
- **readAllTickets():** if cache valid, return it. Otherwise call `sheets.spreadsheets.values.get`, skip header row (index 0), extract column A values, filter empty strings, cache result.
- **getSheetId():** calls `sheets.spreadsheets.get` with `fields: "sheets.properties"`, finds the sheet by title, returns its `sheetId` (handles `sheetId === 0` edge case).
- **getAllTickets():** delegates to `readAllTickets()`
- **getTicket(ticket):** reads all, finds exact match, returns `{ ticket }` or `null`
- **createTicket(ticket):** wrapped in `withWriteLock`. Invalidates cache, reads fresh, checks for duplicates (throw `"Ticket already exists"` → 409), appends via `values.append` with `valueInputOption: "RAW"`, invalidates cache again.
- **updateTicket(oldTicket, newTicket):** wrapped in `withWriteLock`. Invalidates, reads fresh rows, finds row index (skip header), throws `"Ticket not found"` if -1, updates via `values.update` on `tickets!A{rowIndex+1}`, invalidates.
- **deleteTicket(ticket):** wrapped in `withWriteLock`. Invalidates, reads fresh, finds row, gets sheetId, uses `spreadsheets.batchUpdate` with `deleteDimension` request (dimension: ROWS, startIndex: rowIndex, endIndex: rowIndex+1), invalidates. This deletes the entire row rather than just clearing the cell.

### 7.10 `src/services/pedidosService.ts`

- Sheet name: `"pedidos"`, range: `pedidos!A:I`
- **Pedido interface:** `{ uuid, ticket, numero_oab, nome_completo, subsecao, data_solicitacao, data_liberacao, status, anotacoes }` — all strings.
- **rowToPedido(row: string[]):** maps array indices 0-8 to the interface fields (with `|| ""` fallback).
- **pedidoToRow(pedido):** returns array `[uuid, ticket, numero_oab, nome_completo, subsecao, data_solicitacao, data_liberacao, status, anotacoes]`.
- **Cache:** same pattern as tickets (module-level, 5 min TTL).
- **PedidoFilters interface:** `{ status?, ticket?, oab? }` — all optional strings.
- **getAllPedidos(filters?):** reads all, then applies filters in order: case-insensitive status match, exact ticket match, exact oab (numero_oab) match.
- **getPedidoById(uuid):** reads all, finds by uuid.
- **createPedido(data: Omit<Pedido, "uuid">):** wrapped in `withWriteLock`. Generates UUID via `crypto.randomUUID()`, fills missing optional fields with `""`, appends row, invalidates cache.
- **updatePedido(uuid, data: Partial<Omit<Pedido, "uuid">>):** wrapped in `withWriteLock`. Invalidates, reads fresh, finds row by uuid in column A, merges provided fields with existing (using `??`), updates entire row `pedidos!A{n}:I{n}`, invalidates.
- **deletePedido(uuid):** same pattern as tickets — `withWriteLock`, find row, get sheetId, `deleteDimension` batchUpdate, invalidate.

### 7.11 `src/routes/tickets.ts`

Express Router with 5 endpoints. Every route handler has `@openapi` JSDoc annotations for swagger-jsdoc.

| Method | Path | Behavior |
|---|---|---|
| GET | `/` | Calls `getAllTickets()`, maps each string to `{ ticket }`, returns via `successList()` |
| GET | `/:ticket` | Calls `getTicket(req.params.ticket)`, returns 404 if null, otherwise `success()` |
| POST | `/` | Validates body with `createTicketSchema.safeParse`, returns 400 on failure. Calls `createTicket`, returns 201. Catches `"Ticket already exists"` → 409, else 500. |
| PUT | `/:ticket` | Validates body with `updateTicketSchema.safeParse`. Calls `updateTicket(req.params.ticket, parsed.data.ticket)`. Catches `"Ticket not found"` → 404. |
| DELETE | `/:ticket` | Calls `deleteTicket(req.params.ticket)`. Returns `success({ message: "Ticket deleted" })`. Catches `"Ticket not found"` → 404. |

### 7.12 `src/routes/pedidos.ts`

Express Router with 5 endpoints, all with `@openapi` JSDoc annotations.

| Method | Path | Behavior |
|---|---|---|
| GET | `/` | Reads query params `status`, `ticket`, `oab` as filters. Calls `getAllPedidos(filters)`, returns via `successList()`. |
| GET | `/:uuid` | Calls `getPedidoById(req.params.uuid)`, 404 if null. |
| POST | `/` | Validates with `createPedidoSchema.safeParse`, 400 on failure. Calls `createPedido(parsed.data)`, returns 201. |
| PUT | `/:uuid` | Validates with `updatePedidoSchema.safeParse`. Calls `updatePedido(req.params.uuid, parsed.data)`. Catches `"Pedido not found"` → 404. |
| DELETE | `/:uuid` | Calls `deletePedido(req.params.uuid)`. Returns `success({ message: "Pedido deleted" })`. Catches `"Pedido not found"` → 404. |

### 7.13 `src/app.ts` — Express app

1. Set `trust proxy` to `1` (for rate limiting behind reverse proxy)
2. Apply global middleware: `cors()`, `express.json()`, `rateLimiter`
3. Mount Swagger UI at `/docs` (no auth): `app.use("/docs", swaggerUi.serve, swaggerUi.setup(swaggerSpec))`
4. Mount raw spec at `GET /docs.json` (no auth)
5. Mount health check at `GET /health` (no auth): returns `{ status: "ok", timestamp: ISO string }`
6. Mount API routes with auth chain: `app.use("/api/tickets", authRateLimiter, basicAuth, ticketsRouter)` (same for pedidos)
7. 404 handler: returns `error("Endpoint not found")` with status 404
8. Global error handler (4-param middleware): logs error + stack, returns 500 (or `err.status` if set). In development (`NODE_ENV === "development"`), includes actual error message; otherwise returns `"Internal server error"`.
9. Export `app` as default.

### 7.14 `src/index.ts` — VPS/Docker entry point

1. Import dotenv and call `dotenv.config({ path: ".env.local" })` **before** importing app
2. Read `PORT` from env (default 3000)
3. Call `app.listen(PORT)`, log URLs for health check, tickets, and pedidos
4. Graceful shutdown: listen for `SIGTERM` and `SIGINT`, call `server.close()`, force-exit after 10s timeout

### 7.15 `api/index.ts` — Vercel serverless entry point

1. Import dotenv, call `dotenv.config({ path: ".env.local" })` before importing app
2. Import app from `"../src/app"`
3. `export default app`

---

## 8. Deployment Configs

### 8.1 `Dockerfile` — Multi-stage build

**Stage 1 (builder):**
- Base: `node:20-alpine`
- Enable corepack + prepare pnpm (`corepack enable && corepack prepare pnpm@latest --activate`)
- Copy `package.json` and `pnpm-lock.yaml`, run `pnpm install --frozen-lockfile`
- Copy `tsconfig.json` and `src/`, run `pnpm run build`

**Stage 2 (production):**
- Base: `node:20-alpine`
- Labels: maintainer `"CAAB Certificacao API"`, description `"REST API for Primeira Certificacao Google Spreadsheet"`
- Enable corepack + pnpm
- Create non-root user: `addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001 -G nodejs`
- Copy `package.json` + lockfile, install prod deps only (`--frozen-lockfile --prod`)
- Copy built `dist/` from builder with `--chown=nodejs:nodejs`
- Switch to `USER nodejs`
- Expose port 3000
- Healthcheck: `wget --spider -q http://localhost:3000/health || exit 1` (interval 30s, timeout 3s, start-period 5s, retries 3)
- CMD: `["node", "dist/index.js"]`

### 8.2 `docker-compose.yml`

```yaml
services:
  api:
    build: .
    ports:
      - "${PORT:-3000}:3000"
    env_file:
      - .env.local
    volumes:
      - ./credentials.json:/app/credentials.json:ro
    restart: unless-stopped
```

### 8.3 `vercel.json`

```json
{
  "builds": [{ "src": "api/index.ts", "use": "@vercel/node" }],
  "routes": [{ "src": "/(.*)", "dest": "api/index.ts" }]
}
```

---

## 9. `.gitignore`

```
node_modules/
dist/
.env.local
*.json
!package.json
!tsconfig.json
!vercel.json
!postman/*.json
```

Note: `credentials.json` is excluded by the `*.json` glob. The exceptions re-include the committed JSON files.

## 10. `.dockerignore`

```
node_modules
npm-debug.log
.env.local
credentials.json
.git
.gitignore
README.md
CLAUDE.md
dist
docs
```

---

## 11. Postman Collection

Create `postman/caab-api-certificacao.postman_collection.json` (Postman v2.1 schema).

**Collection-level auth:** Basic Auth using variables `{{username}}` / `{{password}}`.

**Variables:**
- `base_url`: `http://localhost:3000`
- `username`: `admin`
- `password`: `changeme`
- `uuid`: `00000000-0000-0000-0000-000000000000`

**Requests:**
1. **Health Check** (GET `{{base_url}}/health`, auth: noauth)
2. **Tickets folder** (5 requests: List all, Get ticket, Create ticket, Update ticket, Delete ticket)
3. **Pedidos folder** (5 requests: List all with query params `status`, `ticket`, `oab`; Get pedido by uuid; Create pedido; Update pedido; Delete pedido)

Use the same example values shown in the Swagger schemas. Create pedido body should include: ticket, nome_completo, numero_oab, subsecao, data_solicitacao, status, anotacoes. Update pedido body: status + data_liberacao.

---

## 12. README.md

Write a comprehensive README with these sections:
1. **Title + description** — managing the "Primeira Certificacao" workflow with Google Sheets as database
2. **Table of Contents** — links to all sections
3. **Tech Stack** — markdown table (Category | Technology) covering: Runtime, Language, Framework, Database, Validation, Documentation, Auth, Security, Linting, Package Manager, Deploy
4. **Project Structure** — ASCII tree matching the file structure above
5. **Prerequisites** — Node.js >= 18, pnpm (with corepack command), Google Cloud project, Service Account
6. **Google Cloud Setup** — step-by-step (create project, enable Sheets API, create service account, download JSON key, place in project root, share spreadsheet with service account email as Editor)
7. **Installation** — clone, pnpm install, cp .env.example .env.local, place credentials.json
8. **Usage** — dev (`pnpm dev`), build/start, lint, API docs at `/docs`
9. **API Reference** — health check example, response format explanation, tickets table with 5 endpoints + curl examples, pedidos table with 5 endpoints + curl examples (including create, filter by status, partial update)
10. **Deployment** — Docker (`docker-compose up --build`) + Vercel (set env vars in dashboard, `vercel deploy`)
11. **Environment Variables** — table (Variable | Description | Required)

Use `admin:changeme` (Base64: `YWRtaW46Y2hhbmdlbWU=`) in curl examples for the Authorization header.

---

## 13. CLAUDE.md

Create the `CLAUDE.md` file with these sections: Project Overview, Tech Stack, Commands (`pnpm dev/build/start`, `docker-compose up --build`), Architecture (describe each directory's purpose), Spreadsheet (ID, sheet names, column details), Environment Variables, Code Conventions (TypeScript strict, CommonJS module system, Zod validation, standardized JSON responses with the three formats).

---

## 14. Git Setup

1. Initialize git repository
2. Create `main` branch, commit all files
3. Create `develop` branch from main
4. Push both branches to GitHub remote `origin` at `mafaltti/caab-api-certificacao`

---

## Key Design Decisions (follow these exactly)

- **CommonJS** module system (`"module": "commonjs"` in tsconfig), not ESM — for maximum compatibility
- **Row deletion** uses `deleteDimension` batchUpdate (deletes the entire spreadsheet row), not clearing cells — this prevents blank rows accumulating
- **Write lock** is a promise-chain mutex, not a boolean flag — ensures serialized writes even under concurrent requests
- **Cache invalidation** happens both **before** (to get fresh data for the operation) and **after** (so subsequent reads see the change) every write operation
- **Swagger docs** at `/docs` and `/docs.json` are **unauthenticated** (publicly accessible), while all `/api/*` routes require Basic Auth
- **Rate limiter** is applied globally to all routes; **auth rate limiter** is applied only to `/api/*` routes (before the basicAuth middleware)
- **Trust proxy** is set to `1` so `req.ip` works correctly behind a reverse proxy
- The Vercel entry point (`api/index.ts`) simply re-exports the Express app — Vercel's `@vercel/node` adapter handles the rest
- **ESLint suppress comment**: In `sheets.ts`, add `// eslint-disable-next-line @typescript-eslint/no-explicit-any -- googleapis type mismatch between GoogleAuth generic params` before the `any` cast
